<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ESP32 å­—åº“ç”Ÿæˆå™¨ V5 (æ”¯æŒè‡ªå®šä¹‰/ç˜¦é‡‘ä½“)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f6f9; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; gap: 25px; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .left { flex: 1; min-width: 350px; } 
        .right { flex: 1.5; display: flex; flex-direction: column; }
        
        /* æ§ä»¶æ ·å¼ */
        .control-group { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        label { font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px; color: #555; }
        input[type="text"], input[type="number"], textarea, select { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        textarea { height: 80px; font-size: 16px; }
        
        /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’®ç¾åŒ– */
        .file-upload { position: relative; display: inline-block; width: 100%; margin-bottom: 10px;}
        .file-upload input[type="file"] { display: none; }
        .file-upload-label { display: block; padding: 10px; background: #6c5ce7; color: white; text-align: center; border-radius: 5px; cursor: pointer; transition: 0.2s; font-weight: bold;}
        .file-upload-label:hover { background: #5649c0; }
        
        .row { display: flex; gap: 10px; } .row > * { flex: 1; }
        
        /* ç”»å¸ƒ */
        canvas { border: 2px solid #ddd; background: #fff; margin: 0 auto; display: block; image-rendering: pixelated; background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0), linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0); background-size: 20px 20px; background-position: 0 0, 10px 10px;}
        
        textarea#code { height: 400px; font-family: monospace; font-size: 12px; background: #2d2d2d; color: #a8bac5; border:none; padding:15px; border-radius:8px;}
        
        button.gen-btn { background:#3498db; color:white; font-weight:bold; padding: 12px; border:none; border-radius:4px; cursor:pointer; font-size:16px; width:100%; margin-top:10px;}
        button.gen-btn:hover { background:#2980b9; }

        .loaded-font-tag { display:none; background:#00b894; color:white; font-size:12px; padding:2px 6px; border-radius:4px; margin-left:5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="panel left">
        <h2>1. å­—ä½“ä¸æ–‡å­—</h2>
        
        <div class="control-group" style="background:#f0f3ff; padding:10px; border-radius:8px; border:1px solid #dce4ff;">
            <label style="color:#6c5ce7;">â˜… ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å­—ä½“æ–‡ä»¶ (.ttf / .otf)</label>
            <div class="file-upload">
                <label for="fontFile" class="file-upload-label">ğŸ“ ç‚¹å‡»åŠ è½½ç˜¦é‡‘ä½“/å…¶ä»–å­—ä½“æ–‡ä»¶</label>
                <input type="file" id="fontFile" accept=".ttf,.otf,.woff">
            </div>
            <div id="fontStatus" style="font-size:12px; color:#666; text-align:center;">å½“å‰ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“</div>
        </div>

        <div class="control-group">
            <label>è¾“å…¥æ–‡å­—:</label>
            <textarea id="txt">å†¬æœˆåä¸€</textarea>
        </div>
        
        <div class="control-group">
            <div class="row">
                <div><label>å­—åº“å¯¹è±¡å (è‹±æ–‡)</label><input type="text" id="fontName" value="ShouJin_32"></div>
            </div>
            <div class="row" style="margin-top:5px;">
                <div><label>å®½ (px)</label><input type="number" id="w" value="32"></div>
                <div><label>é«˜ (px)</label><input type="number" id="h" value="32"></div>
            </div>
        </div>

        <div class="control-group">
            <div class="row">
                <div><label>å­—å· <span id="val_size">28</span></label><input type="range" id="size" min="8" max="128" value="28"></div>
                <div><label>ç²—ç»† <span id="val_weight">400</span></label><input type="range" id="weight" min="100" max="900" step="100" value="400"></div>
            </div>
            <div class="row">
                <div><label>X åç§» <span id="val_ox">0</span></label><input type="range" id="ox" min="-30" max="30" value="0"></div>
                <div><label>Y åç§» <span id="val_oy">4</span></label><input type="range" id="oy" min="-30" max="30" value="4"></div>
            </div>
            <label>äºŒå€¼åŒ–é˜ˆå€¼ <span id="val_th">128</span></label><input type="range" id="th" min="1" max="255" value="128">
        </div>
        
        <button class="gen-btn" onclick="gen()">ç”Ÿæˆ C++ ä»£ç </button>
    </div>

    <div class="panel right">
        <h2>2. æ•ˆæœé¢„è§ˆ</h2>
        <div style="text-align:center; padding:10px; margin-bottom:10px;">
            <canvas id="cvs"></canvas>
            <div style="font-size:12px; color:#666; margin-top:5px;">é¢„è§ˆå›¾ (CSSæ”¾å¤§æ˜¾ç¤ºï¼Œç”Ÿæˆæ•°æ®ä¸º <span id="realSize">32x32</span>)</div>
        </div>
        <textarea id="code" readonly placeholder="ç‚¹å‡»ç”Ÿæˆä»£ç ..."></textarea>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);
    const ctx = $('cvs').getContext('2d');
    
    // çŠ¶æ€å˜é‡
    let customFontFamily = null; // å­˜å‚¨åŠ è½½çš„å­—ä½“å

    // ç›‘å¬å­—ä½“æ–‡ä»¶ä¸Šä¼ 
    $('fontFile').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(event) {
            try {
                const data = event.target.result;
                // ä½¿ç”¨ FontFace API åŠ¨æ€åŠ è½½å­—ä½“
                const fontName = 'UserCustomFont';
                const fontFace = new FontFace(fontName, data);
                await fontFace.load();
                document.fonts.add(fontFace);
                
                customFontFamily = fontName;
                
                // æ›´æ–° UI
                $('fontStatus').innerHTML = `âœ… å·²åŠ è½½: <strong>${file.name}</strong>`;
                $('fontStatus').style.color = '#00b894';
                
                // è‡ªåŠ¨åˆ·æ–°
                gen();
            } catch (err) {
                alert('å­—ä½“åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿æ˜¯æœ‰æ•ˆçš„ .ttf æˆ– .otf æ–‡ä»¶');
                console.error(err);
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // æ›´æ–°æ˜¾ç¤ºæ•°å€¼
    ['size','weight','ox','oy','th'].forEach(k => {
        $(k).addEventListener('input', () => {
            $(`val_${k}`).innerText = $(k).value;
            gen();
        });
    });
    
    ['txt','w','h','fontName'].forEach(k => $(k).addEventListener('input', gen));

    function gen() {
        const text = $('txt').value;
        const W = parseInt($('w').value), H = parseInt($('h').value);
        const name = $('fontName').value || "MyFont";
        
        $('realSize').innerText = `${W}x${H}`;
        
        // è°ƒæ•´ Canvas å°ºå¯¸ (å†…éƒ¨åˆ†è¾¨ç‡)
        $('cvs').width = W; 
        $('cvs').height = H;
        
        // CSS ç¼©æ”¾é¢„è§ˆ (è®©å°å°ºå¯¸ä¹Ÿèƒ½çœ‹æ¸…)
        const scale = W < 64 ? 6 : 2; 
        $('cvs').style.width = (W * scale) + 'px'; 
        $('cvs').style.height = (H * scale) + 'px';

        // æ ¸å¿ƒå¤„ç†å‡½æ•°ï¼šç»˜åˆ¶å¹¶æå–
        const process = (char, draw) => {
            // æ¸…ç©ºèƒŒæ™¯
            if(draw) {
                ctx.fillStyle = 'white'; 
                ctx.fillRect(0,0,W,H);
                ctx.fillStyle = 'black';
                
                // å­—ä½“é€‰æ‹©é€»è¾‘ï¼šæœ‰è‡ªå®šä¹‰ç”¨è‡ªå®šä¹‰ï¼Œæ²¡æœ‰ç”¨é»˜è®¤
                const family = customFontFamily ? customFontFamily : 'sans-serif';
                ctx.font = `${$('weight').value} ${$('size').value}px "${family}"`; 
                
                ctx.textAlign='center'; 
                ctx.textBaseline='middle';
                ctx.fillText(char, W/2 + parseInt($('ox').value), H/2 + parseInt($('oy').value));
            }
            if(draw) return;

            // æå–åƒç´ 
            const img = ctx.getImageData(0,0,W,H).data;
            const th = parseInt($('th').value);
            let hex = "";
            const bytesPerRow = Math.ceil(W/8);
            
            for(let y=0; y<H; y++) {
                for(let b=0; b<bytesPerRow; b++) {
                    let byte=0;
                    for(let i=0; i<8; i++) {
                        let x = b*8+i;
                        if(x<W) {
                            // RGBå‡å€¼åˆ¤æ–­é»‘ç™½
                            const avg = (img[(y*W+x)*4] + img[(y*W+x)*4+1] + img[(y*W+x)*4+2])/3;
                            if(avg < th) byte |= (1<<(7-i));
                        }
                    }
                    hex += "0x"+byte.toString(16).toUpperCase().padStart(2,'0')+",";
                }
                hex += "\n  ";
            }
            return hex.replace(/,$/, ''); // å»æ‰æœ€åä¸€ä¸ªé€—å·
        };

        // 1. å…ˆé¢„è§ˆç¬¬ä¸€ä¸ªå­—
        if(text) process(text[0], true);

        // 2. ç”Ÿæˆä»£ç 
        const unique = [...new Set(text.split('').filter(c=>c.trim()))].sort();
        let s = `#ifndef ${name}_H\n#define ${name}_H\n\n#include "HanziDriver.h"\n\n`;
        let list = "";
        
        unique.forEach(c => {
            process(c, true); // é‡ç»˜åˆ° canvas ä»¥ä¾¿æå–
            const data = process(c, false);
            const code = c.charCodeAt(0).toString(16).toUpperCase();
            const arrName = `BMP_${name}_${code}`;
            s += `// ${c}\nconst unsigned char ${arrName}[] PROGMEM = {\n  ${data}\n};\n`;
            list += `  {0x${code}, ${arrName}},\n`;
        });

        s += `\nconst FontItem_t TABLE_${name}[] PROGMEM = {\n${list}};\n\n`;
        s += `// å­—ä½“å¯¹è±¡: ${name}\n`;
        s += `const HanziFont ${name} = {\n  ${W}, ${H},\n  TABLE_${name},\n  ${unique.length}\n};\n\n#endif`;
        
        $('code').value = s;
    }
    
    window.onload = gen;
</script>
</body>
</html>